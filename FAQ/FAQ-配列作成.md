###### [FAQ HOME](../FAQ.md#FAQ-HOME)

# FAQ 配列作成編

## 目次

- [新しい配列(テーブルファイル)を作成したい](#新しい配列テーブルファイルを作成したい)
- [使用するキーとその漢直キーコード](#使用するキーとその漢直キーコード)
- [単打用テーブル](#単打用テーブル)
- 多ストローク用テーブル
- [シフト打鍵用テーブル](#シフト打鍵用テーブル)
    - [順次打鍵での前置シフト](#順次打鍵での前置シフト)
    - [SandS による連続シフト](#SandS-による連続シフト)
    - [連続シフトありの前置シフト](#連続シフトありの前置シフト)
    - [連続シフトありの相互シフト同時打鍵](#連続シフトありの相互シフト同時打鍵)
    - [ワンショット(連続シフトなし)の相互シフト同時打鍵](#ワンショット連続シフトなしの相互シフト同時打鍵)
    - [漢直モードがOFFの時(英数モードの時)も同時打鍵を有効にしたい](#漢直モードがOFFの時英数モードの時も同時打鍵を有効にしたい)
    - [打鍵列の定義が重複したときに警告を出したい](#打鍵列の定義が重複したときに警告を出したい)
    - [打鍵列の定義が重複しても警告を出したくない](#打鍵列の定義が重複しても警告を出したくない)
- [矢印記法とは何ですか](#矢印記法とは何ですか)
    - [簡略記法](#簡略記法)
    - [ブロック内でのプレースホルダー記法](#ブロック内でのプレースホルダー記法)
    - [既定のプレースホルダー](#既定のプレースホルダー)
- [「無変換」キーや「変換」キーを同時打鍵シフトキーとして使いたい](#無変換キーや変換キーを同時打鍵シフトキーとして使いたい)
    - [「無変換」キーや「変換」キーを単打したときはそのまま「無変換」「変換」キーとしたい](#無変換キーや変換キーを単打したときはそのまま無変換変換キーとしたい)
- [「無変換」キーや「変換」キーを拡張シフトキーとして使いたい](#無変換キーや変換キーを拡張シフトキーとして使いたい)
- [同じ構造のテーブルの記述を省略したい](#同じ構造のテーブルの記述を省略したい)
- [別のテーブルファイルを使い回したい](#別のテーブルファイルを使い回したい)
- かな配列と漢直配列を同時に使用したい
- [選択時に表示される説明文を設定したい](#選択時に表示される説明文を設定したい)

## 新しい配列(テーブルファイル)を作成したい
配列は、`tables` フォルダの配下にある `.tbl` という拡張子を持つテキストファイルで定義します。
このファイルのことを「テーブルファイル」と呼称しています。

テーブルファイルには、キーを表す「漢直キーコード」とそれに対応する出力文字(列)を記述します。

新しい配列を作成する場合は、まずは既存のテーブルファイルを開いてみて、雰囲気をつかんでください。

## 使用するキーとその漢直キーコード
テーブルファイルに記述するのは、下図のキーボードレイアウトで
数字の背景色が青と緑になっている文字キー(0～48)および背景色がピンク色になっている特殊キー(50～99)です。
背景色の付いた数字は、各キーに割り振られた「**漢直キーコード**」を示しています。

![Keyboard Layout](image/keyboard-layout.png)

漢直キーコードと出力文字(列)の対応は「矢印記法」
（詳細は「[矢印記法とは何ですか](#矢印記法とは何ですか)」を参照）で記述するのが基本です。
でもすべての定義をこの記法で書くのは面倒なので、
より直感的に書ける記法が用意されています。

## 単打用テーブル
下図は「月配列（2-263式）」(tuki-2-263.tbl)からの抜粋です。

![Single Hit Tuki](image/single-hit-tuki.png)

`{` と `}` で囲まれたところに、漢直キーコード 0 ～ 48 のキーに対応する文字（あるいは文字列）を、
キーボードの4段に対応する形で `|` で区切って文字を並べます。
文字(列)の前後には任意個の半角空白文字を置くこともできます。
出力文字がないところには、0個以上の任意個の半角空白文字を並べます。

以下のような特徴があります。

- 出力文字(列)が半角英数字および全角文字だけからなる場合は、ダブルクォートで囲む必要がない
- 同時打鍵に使われるキーの場合でも、単打では記述された文字が出力される
- 出力文字の記述のないキー
    - 同時打鍵に使われないキーは、単打により本来のキーボードによる打鍵文字が出力される
    - 同時打鍵にも使われるキーの場合は、単打では文字の出力を行わない
    - スペースキーに対応する文字や機能を設定したい場合は5段目に書く
- 各段の後半部で出力文字の記述のないキーが末尾まで連続する場合は、その部分を省略できる（ただし、最低でも1つの `|` は必要）
- 「゛」と「゜」は直前の出力文字を濁音化(半濁音化)する機能を呼び出す

## シフト打鍵用テーブル
### 順次打鍵での前置シフト
下図は「月配列（2-263式）」(tuki-2-263.tbl)からの抜粋です。

![Sequencial Tuki](image/sequencial-tuki.png)

[矢印記法](#矢印記法とは何ですか)で前置シフトキーの漢直キーコードを記述した後、単打の場合と同様にテーブル構造を記述します。
なお `;`
は、それ以降行末までコメントであることを表します。


### SandS による連続シフト
スペースキーにシフトキーと同様の機能を持たせ、拡張シフト面に割り当てる設定です。
下図は「薙刀式 v15(仮)」(naginata15.tbl)からの抜粋です。

![Sands Directive](image/sands-directive.png)

テーブル記述の前後を `#SandS` と `#end SandS` で
囲みます。

### 連続シフトありの前置シフト
同時打鍵で連続シフトありだけれども、シフトキーが前置の場合のみ有効なケース。

![Combo Prefix](image/combo-prefix.png)

テーブル記述の前後を `#combination prefix` と `#end combination` で
囲みます。

### 連続シフトありの相互シフト同時打鍵
同時打鍵で連続シフトあり、かつシフトキーの順序が前後しても構わないケース。
下図は「薙刀式 v15(仮)」(naginata15.tbl)からの抜粋です。

![Combo Succ Nagi](image/combo-succ-nagi.png)

テーブル記述の前後を `#combination successive` と `#end combination` で
囲みます。

### ワンショット(連続シフトなし)の相互シフト同時打鍵
同時打鍵かつシフトキーの順序が前後しても構わないが、連続シフトは不可のケース。
下図は「新下駄配列」(shin-geta.tbl)からの抜粋です。

![Combo Oneshot](image/combo-oneshot.png)

テーブル記述の前後を `#combination oneshot` と `#end combination` で
囲みます。

### 漢直モードがOFFの時(英数モードの時)も同時打鍵を有効にしたい
通常は、同時打鍵定義は漢直モードがONのときだけ有効です。
これを、漢直モードがOFF(英数モード)のときだけ有効にしたり、どちらのモードでも有効にしたりすることができます。

#### 英数モードのときだけ有効な同時打鍵定義
次のように、同時打鍵定義のところを `#enableComboOnEisu` と `#end enableComboOnEisu`
で囲んでください。
下記は、漢直モードが OFF (英数モード)の時だけ、`JH` の同時押しで IME ON にする設定です。

```
;; IME ON
#combination oneShot
#enableComboOnEisu
-J,H>"!{ImeOn}"
-$F,$G>"!{ImeOff}"
#end enableComboOnEisu
#end combination
```

#### 漢直モードでも英数モードでも有効な同時打鍵定義
次のように、同時打鍵定義のところを `#enableComboOnBoth` と `#end enableComboOnBoth`
で囲んでください。
下記は、どちらのモードでも `FG` の同時押しで IME OFFにする設定です。
```
;; IME OFF
#combination oneShot
#enableComboOnBoth
-F,G>"!{ImeOff}"
#end enableComboOnBoth
#end combination
```

#### 同じ同時打鍵に対して両モードで異なる定義をする
下記は、`JH` の同時押しで、漢直モード時は IME OFF、英数モード時は IME ON にする設定です。
```
;; IME ON/OFF
#combination oneShot
-J,H>"!{ImeOff}"
#enableComboOnEisu
-J,H>"!{ImeOn}"
#end enableComboOnEisu
#end combination
```

### 打鍵列の定義が重複したときに警告を出したい
次のような打鍵列を定義すると、A のキーには文字「あ」と2ストロークの第1打鍵の両方が定義されてしまいます。
デフォルトでは後から定義したほうが優先され、黙って前に定義したものを上書きしてしまいます。

```
-a>あ
-a,s>あす
```
このようなケースで、上書きが発生した時に警告を出すように設定することができます。
下図のように「詳細設定」>「テーブルファイル読み込み時の重複チェック」で「重複チェックを行う」
にチェックを入れてください。

![Overwrite Warning](image/overwrite-warning.png)

### 打鍵列の定義が重複しても警告を出したくない
逆に打鍵列の定義が重複しても意図したものなので警告を出したくない場合は、
テーブルファイルの当該箇所を `#ignoreWarning overwrite` ～ `#enableWarning overwrite`
で囲んでください。

```

```

## 矢印記法とは何ですか
テーブルファイルにおける最も基本的な記法です。以下のような形式で記述します。
```
-{漢直キーコード}>"出力文字列"
```
`{漢直キーコード}`にはキーに割り振られた 0～99 の漢直キーコードを記述します。たとえば、
```
-10>"あ"
```
と記述してあると、`Q` を押したときに「あ」が出力されます。

複数キーの順次打鍵によって出力文字を定義する場合は、矢印記法を重ねることができます。
```
-23>-25>"愛"
```
これは、`FH`と打鍵したときに「愛」を出力する定義となっています。
複数キーの打鍵列では、`>-` を `,` で置き換えた次のような簡略記法も使えます。
```
-20,21,22,23,26,27,28,29>"くぁwせdrftgyふじこlp"
```
これは、`ASDFJKL;` と順に打鍵したときに「くぁwせdrftgyふじこlp」と出力する定義です。

### 簡略記法
漢直キーコードが 0～39 および 41, 44, 46 のものについては、`$a` や `$.` といった簡略記法が可能です。
`$` の直後に対応する QWERTY 文字を指定してください。
使えるのは、 `$0` ～ `$9`, `$A` ～ `$Z`, `$a` ～ `$z` および
`$;` `$,` `$.` `$/` `$-` `$@` `$:` です。
さらに、英1文字の場合は、`$` を省略することも可能です。

記述例： `a` `.` と打鍵したときに「ぬ」を出力する
```
-a,$.>ぬ
```
上記例で、`a` の後の `,` は、漢直キーコードの並びを区切るカンマであることに注意。

### ブロック内でのプレースホルダー記法
配列を `|` によるブロックで記述した場合、1つのセルに長い文字列があると見ためのレイアウトが崩れてしまうことがあります。

見ためのレイアウトを保持しつつ長い文字列を定義したい場合は、
いったんセルに対して「プレースホルダー」を設定しておき、後でそれを参照するようにすると便利です。

プレースホルダーは、 `$` の後に英数字が続いた形式をとります。
下図は「薙刀式」の単打面でのプレースホルダーの使用例です。
`T` `Y` `U` のキーに、それぞれ `$dn` `$up` `bs` というプレースホルダーを設定しておき、
後でそれらに実際の出力文字列(ここでは機能キーの呼び出し)を定義しています。

![Arrow Placeholder](image/arrow-placeholder.png)

プレースホルダーとして、前述の簡略記法(`$A` など)を用いることもできます。
これらを用いる場合は、あらかじめプレースホルダーを設定する必要はありません。
下図は、上図を簡略記法で書き換えたものです。

![Arrow Placeholder 2](image/arrow-placeholder-2.png)

### 既定のプレースホルダー
いくつかのキーについては、既定のプレースホルダー名が定義されています。

|名前|対応するキー|漢直キーコード|
|--|--|:--:|
|sc|セミコロン (`:`)|29|
|cm|カンマ (`,`)|37|
|pd|ピリオド (`.`)|38|
|sl|スラッシュ (`/`)|39|
|space|スペース|40|
|hp|ハイフン (`-`)|41|
|at|アットマーク (`@`)|44|
|cl|コロン (`:`)|46|
|ej<br/>hz|半角/全角|51|
|tab|Tab|52|
|caps|Caps Lock|53|
|alnum<br/>eisu|英数|54|
|nfer|無変換|55|
|xfer|変換|56
|kana|ひらがな|57|

これらのプレースホルダーおよび上述の簡略記法(`$A`など)は、ブロック外(トップレベル)でも使用することができます。

下図は、「月林檎配列」における使用例です。

![Place Holder](image/place-holder.png)
## 「無変換」キーや「変換」キーを同時打鍵シフトキーとして使いたい
親指シフトの親指キーとして「無変換」「変換」キーを使いたい場合は、
それらのキーに対応する漢直キーコードを[矢印記法](#矢印記法とは何ですか)のところに記述します。

![Nicola Nfer](image/nicola-nfer.png)

![Nicola Xfer](image/nicola-xfer.png)

「無変換」などの特殊キー(機能キー)の漢直キーコードは 50～99 となりますが、`X0～X49` と書くこともできます。
この場合「変換」キーは `X6` となります。

**注意**<br/>
「無変換」キーや「変換」キーを同時打鍵シフトキーとして使う場合は、
これらのキーを「拡張シフトキー」として使用しないでください。

[キーアサイン編](FAQ-キーアサイン.md#FAQ-HOME)で説明している拡張修飾キー設定をしている場合でも、
これらのキーを拡張シフトキーとして強制的に使用不可とするためのディレクティブ

- #disableExtKey nfer
- #disableExtKey xfer

を用意していますので、必要に応じて活用してください。
(`tables/nicola.tbl` に例があります。)

### 「無変換」キーや「変換」キーを単打したときはそのまま「無変換」「変換」キーとしたい
「無変換」キーや「変換」キーを同時打鍵シフトキーとして使っている場合に、
それらを単打した時は本来の「無変換」「変換」キーとして使えるようにできます。

設定ダイアログの「同時打鍵・IME」>「『変換』キーと『無変換」キー」>
「単打の場合は本来のキーとして機能する」にチェックを入れてください。
(初期状態ではチェックが入っています)

![Xfer Nfer Single Hit](image/xfer-nfer-single-hit.png)

逆に、これらのキーを単打したときには何も機能させたくない場合は、上図のチェックを外してください。

#### テーブルファイルによる設定
なお、下記のような設定をテーブルファイルに追加することでも同様の効果が得られます
(というか、上図のチェックを入れると下記の設定が自動的に追加されるようになります)。
なので、特定のキーだけ、本来の機能を実行させたいような場合は、
上図のチェックを外して特定キーのみ、下記設定を追加してください。

```
;; 「無変換」「変換」を単打したとき、そのまま「無変換」「変換」キーとする設定
-$nfer>"!{Nfer}"
-$xfer>"!{Xfer}"
```

下図は NICOLA における設定例です。

![Xfer Nfer Single](image/xfer-nfer-single.png)

## 「無変換」キーや「変換」キーを拡張シフトキーとして使いたい
SandS と同様に「無変換」や「変換」もシフトキーとして使いたいというケース。
同時打鍵ではなく、あくまでも「シフトキー」と同様の使い方をしたい場合となります。
下図は「薙刀式 v15 w/ TUT」(naginata15-tut.tbl)からの抜粋です。

![Nfer Xfer As Exshift](image/nfer-xfer-as-exshift.png)

まず `#assignPlane` で `xfer`(変換)や`nfer`(無変換)
キーに拡張シフト面を割り当てます。
拡張シフト面は、 `shiftB` ～ `shiftF` の5面から選択します。
(`shiftA` は `SandS` のデフォルトとして予約済みのため)

その後、 `#shiftB`(～`shiftF`) と `#end shift` でテーブル定義部を囲みます。
`#end shift` が来るまでテーブル定義は拡張シフト面に定義されることになるので、
適切な場所で必ず `#end shift` を記述してください。

## 同じ構造のテーブルの記述を省略したい
月系のかな配列では D と K の中指前置に対して同じテーブルが使われます。
このようなケースでは、テーブル記述をいったん変数に記録しておいて、後でそれを呼び出すことができます。

![Store Load](image/store-load.png)

`#store 変数名` と `#end sotre`
で囲んだ部分が `変数名` で指定される変数に格納されます。
変数に格納された部分は、後で `#load 変数名`
で呼び出すことができます。

## 別のテーブルファイルを使い回したい
テーブルファイル全体を使い回したい場合は `#include` を使います。
下図は「月配列（2-263式）連続シフト版」(tuki-2-263.pfx.tbl)からの抜粋です。

![Include Tablefile](image/include-tablefile.png)


行頭から `#include` と記述し、続けてダブルクォートで囲んで読み込むテーブルファイル名を記述します。
テーブルファイルは、インクルード元ファイルからの相対パスで記述してください。


## 選択時に表示される説明文を設定したい
テーブルファイル選択用のコンボボックスに表示される説明文を設定するのには `#define display-name`
を使います。

![Display Name](image/display-name.png)

`#define display-name`
の後にダブルクォートで囲んで説明文を記述します。

